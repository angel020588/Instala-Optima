CÃ“DIGO DEL BACKEND (Node.js en Replit)

Modifica tu index.js para devolver una orden en la respuesta:

// index.js (fragmento)

app.post('/api/esp32', (req, res) => {
  const { nivel, estado } = req.body;

  console.log(`ğŸ“¥ Datos del ESP32 â†’ Nivel: ${nivel}%, Estado: ${estado}`);

  // ğŸ” LÃ³gica de decisiÃ³n (ejemplo simple)
  let orden = 'ESPERAR';

  if (parseInt(nivel) <= 30) {
    orden = 'ENCENDER';
  } else if (parseInt(nivel) >= 90) {
    orden = 'APAGAR';
  }

  console.log(`ğŸš¦ Enviando orden al ESP32: ${orden}`);
  res.status(200).send(orden); // ğŸ‘‰ Se envÃ­a como texto plano
});

ğŸ“Ÿ 2. CÃ“DIGO DEL ESP32

Ajusta tu cÃ³digo para capturar la orden del servidor:

#include <WiFi.h>
#include <HTTPClient.h>
#include <WiFiClientSecure.h>

const char* ssid = "TU_SSID";
const char* password = "TU_PASSWORD";

const char* serverName = "https://instala-optima-ecotisat.replit.app:5000/api/esp32";

void setup() {
  Serial.begin(115200);
  pinMode(5, OUTPUT); // ğŸ‘ˆ Suponiendo que el relÃ© o enchufe estÃ¡ en GPIO 5

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ… WiFi conectado");

  // ğŸ‘‰ ComunicaciÃ³n HTTPS
  WiFiClientSecure client;
  client.setInsecure(); // âš ï¸ Solo para pruebas

  HTTPClient https;
  https.begin(client, serverName);
  https.addHeader("Content-Type", "application/x-www-form-urlencoded");

  String postData = "nivel=25&estado=esperar"; // Simula nivel bajo
  int httpResponseCode = https.POST(postData);

  if (httpResponseCode > 0) {
    String orden = https.getString();
    Serial.print("ğŸ“© Orden recibida del servidor: ");
    Serial.println(orden);

    // ğŸ‘‰ Ejecutar orden
    if (orden == "ENCENDER") {
      digitalWrite(5, HIGH);  // Enciende relÃ©
      Serial.println("âš¡ RelÃ© ENCENDIDO");
    } else if (orden == "APAGAR") {
      digitalWrite(5, LOW);   // Apaga relÃ©
      Serial.println("ğŸ›‘ RelÃ© APAGADO");
    } else {
      Serial.println("â¸ï¸ Esperando instrucciones...");
    }

  } else {
    Serial.print("âŒ Error HTTP: ");
    Serial.println(httpResponseCode);
  }

  https.end();
}

void loop() {
  // AquÃ­ podrÃ­as repetir la consulta cada X minutos, si quieres que sea dinÃ¡mico
}

âœ… Resultado esperado
Si el nivel de agua es 25:

El backend responde ENCENDER

El ESP32 activa el GPIO 5 (enciende relÃ© o enchufe)

Imprime en el monitor serial:

ğŸ“© Orden recibida del servidor: ENCENDER
âš¡ RelÃ© ENCENDIDO
